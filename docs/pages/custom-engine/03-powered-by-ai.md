# B3 - Enhance user experience with the Powered by AI kit

In this lab you will learn about the Powered by AI, a set of features Teams AI library provides and utilize them in your custom engine copilot to enhance the user experience.

???+ info "Navigating the Building your own copilot labs (B Path)"
    - [Lab B0 - Prerequisites](/copilot-camp/pages/custom-engine/00-prerequisites)
    - [Lab B1 - Build a custom engine copilot using Azure OpenAI and Teams Toolkit](/copilot-camp/pages/custom-engine/01-custom-engine-copilot)
    - [Lab B2 - Index your data in Azure AI Search and bring it into your custom engine copilot](/copilot-camp/pages/custom-engine/02-rag)
    - [Lab B3 - Enhance user experience with the Powered by AI kit](/copilot-camp/pages/custom-engine/03-powered-by-ai) (üìç You are here)
    - [Lab B4 - Add actions to handle complex tasks](/copilot-camp/pages/custom-engine/04-actions)
    - [Lab B5 - Secure your solution using authentication](/copilot-camp/pages/custom-engine/05-authentication)

In this lab you will:

- Learn what are the Powered by AI features
- Enable Feedback Loop to collect user feedback
- Customize citations with Adaptive Cards
- Enable Generated by AI label
- Enable Sensitivity Label

## Introduction

???+ info "What is Powered by AI?"
    Powered by AI is a set of features offered by the Teams AI library that make interactions with custom engine copilots more engaging and user-friendly. The features include:

    * **Feedback Loop:** Allows users to rate AI responses with thumbs up or down. This feedback helps improve the AI's accuracy and usefulness over time.
    
    * **Citations:** Shows the sources of information provided by the AI, similar to references, so users know where the information comes from.
    
    * **Generated by AI:** Indicates that a message is created by an AI system, not a human. You'll see an "AI generated" label on top of each message generated by the AI system.
    
    * **Sensitivity Information:** A sensitivity label appears on top of the message if the information shared by the AI is sensitive and advises whether it can be shared outside your organization.

In the previous exercise, you learned about the concept of Retrieval-Augmented Generation (RAG) and how to integrate RAG into your custom engine copilot. In this exercise, you'll utilize the Powered by AI features and customize the user experience to make your custom engine copilot more user-friendly.

- Create an index on Azure AI Search.
- Generate vector embeddings for the resumes (PDF documents).
- Upload the data in chunks to Azure AI Search.

Finally, you'll integrate your custom engine copilot with Azure AI Search to chat with your data and obtain the best results.

## Exercise 1: Enable Feedback Loop

In this exercise, you can continue using the same source code you've built in the previous lab.

### Step 1: Integrate Feedback Loop in your app

1. In your project, open `src/app/app.ts`, locate your application instance and add `enable_feedback_loop: true` inside the **ai** property brackets. The updated application instance will look like the following:

```javascript
const app = new Application({
  storage,
  ai: {
    planner,
    //feedback loop is enabled
    enable_feedback_loop: true
  },
});
```

1. To handle the feedback responses, add the following code snippet in the `src/app/app.ts`:

```javascript
app.feedbackLoop(async (_context, _state, feedbackLoopData) => {
  if (feedbackLoopData.actionValue.reaction === 'like') {
      console.log('üëç' + ' ' + feedbackLoopData.actionValue.feedback!);
  } else {
      console.log('üëé' + ' ' + feedbackLoopData.actionValue.feedback!);
  }
});
```

### Step 2: Test Feedback Loop

Let's test Career Genie with the Feedback Loop. Start debugging your app by selecting **Run and Debug** tab on Visual Studio Code and **Debug in Teams (Edge)** or **Debug in Teams (Chrome)**. Microsoft Teams will pop up on your browser. Once your app details show up on Teams, select **Add** and start chatting with your app.

Before testing the Feedback Loop, type "Hi" or ask a questions such as "Suggest me .NET developers who can speak Spanish". You'll recognize that the message you receive from your custom engine copilot has thumbs up and down buttons at the bottom right corner.

Now, let's test the feedback loop. Select thumbs up or down, and immediately the feedback card will pop-up. Provide some feedback in text in the card and hit **Submit**.

To validate your feedback, go back to Visual Studio Code and check your terminal, your feedback will show up there with thumbs up / down and your comment.

## Exercise 2: Customize citations with Adaptive Cards

When a data source is defined in a custom engine copilot, Teams AI library dynamically enables citations to refer the related documents. In the current citation experience, user can hover-on the citation and see the beginning of the document. To extend this experience, you can use Adaptive Cards and customize the way citations look.

### Step 1: Create an Adaptive Card for citations

Go to `src/app/` folder and create a new file named **card.ts**. Add the following code snippet inside the `card.ts` file:

```javascript
import { AdaptiveCard, Message, Utilities } from '@microsoft/teams-ai';
/**
 * Create an adaptive card from a prompt response.
 * @param {Message<string>} response The prompt response to create the card from.
 * @returns {AdaptiveCard} The response card.
 */

//Adaptive card to display the response and citations
export function createResponseCard(response: Message<string>): AdaptiveCard {
    const citationCards = response.context?.citations.map((citation, i) => ({
            type: 'Action.ShowCard',
            title: `${i+1}`,
            card: {
                type: 'AdaptiveCard',
                body: [
                    {
                        type: 'TextBlock',
                        text: citation.title,
                        fontType: 'Default',
                        weight: 'Bolder'
                    },
                    {
                        type: 'TextBlock',
                        text: citation.content,
                        wrap: true
                    }
                ]
            }
        }));
    
    const text = Utilities.formatCitationsResponse(response.content!);
    return {
        type: 'AdaptiveCard',
        body: [
            {
                type: 'TextBlock',
                text: text,
                wrap: true
            },
            {
                type: 'TextBlock',
                text: 'Citations',
                wrap: true,
                fontType: 'Default',
                weight: 'Bolder'
            },
            {
                type: 'ActionSet',
                actions: citationCards
            }
        ],
        $schema: 'http://adaptivecards.io/schemas/adaptive-card.json',
        version: '1.5'
    };
}
```

This Adaptive Card allows you to list citations as `Action.ShowCard` buttons which show more details when clicked. It also shows the main content of the response together with the citation buttons. If user wants to learn more about the citation, they can click on the button to read the entire document.

### Step 2: Use PredictedSayCommand to customize the citation experience

1. Go to `src/app/app.ts` and add the following snippet on top of your code to import your adaptive card:

```javascript
import { createResponseCard } from './card';
```

1. Add `PredictedSayCommand` inside the "@microsoft/teams-ai" import, the updated version of the import will look like the following:

```javascript
import { Application, ActionPlanner, OpenAIModel, PromptManager, AI, PredictedSayCommand} from "@microsoft/teams-ai";
```

1. Add the following PredictedSayCommand action in the `src/app/app.ts` to customize the citation:

```javascript
app.ai.action<PredictedSayCommand>(AI.SayCommandActionName, async (context, state, data, action) => {
  let activity;
  if (data.response.context && data.response.context.citations.length > 0 ) {
      const attachment = CardFactory.adaptiveCard(createResponseCard(data.response));
      activity = MessageFactory.attachment(attachment);
  }
  else {
      activity = MessageFactory.text(data.response.content);
  }

  activity.entities = [
    {
        type: "https://schema.org/Message",
        "@type": "Message",
        "@context": "https://schema.org",
        "@id": ""
    }
  ];
  activity.channelData = {
    feedbackLoopEnabled: true
  };

  await context.sendActivity(activity);

  return "success";
 
});

export default app;
```

### Step 3: Test the customized citation experience

Let's test Career Genie with the customized citation experience. Start debugging your app by selecting **Run and Debug** tab on Visual Studio Code and **Debug in Teams (Edge)** or **Debug in Teams (Chrome)**. Microsoft Teams will pop up on your browser. Once your app details show up on Teams, select **Add** and start chatting with your app.

To test the new citation experience, start by greeting Career Genie like "Hi" or "Hello". Then, try to ask one of the questions below, or similar to see the new citations:

- *Can you suggest a candidate who is suitable for spanish speaking role that requires at least 2 years of .NET experience?*
- *Who are the other good candidates?*
- *Who would be suitable for a position that requires 5+ python development experience?*
- *Can you suggest any candidates for a senior developer position with 7+ year experience that requires Japanese speaking?*

Now, recognize that our new Adaptive Card experience provides a button for each citation. Click on citation buttons to extend the view and review the resume details for each candidate.

## Exercise 3: Enable Generated by AI label

### Step 1: Use PredictedSayCommand to enable the Generated by AI label

Go to `src/app/app.ts` and locate your `PredictedSayCommand` action. Add the following code snippet inside `activity.entities`:

```javascript
// Generated by AI label
additionalType: ["AIGeneratedContent"],
```

### Step 2: Test Generated by AI label

Let's test Career Genie with the Generated by AI label. Start debugging your app by selecting **Run and Debug** tab on Visual Studio Code and **Debug in Teams (Edge)** or **Debug in Teams (Chrome)**. Microsoft Teams will pop up on your browser. Once your app details show up on Teams, select **Add** and start chatting with your app.

To test the Generated by AI label, simply greet Career Genie and the first message you'll receive will have a small label "AI generated" on top.

## Exercise 4: Enable Generated by AI label

### Step 1: Use PredictedSayCommand to enable the Sensitivity label

Go to `src/app/app.ts` and locate your `PredictedSayCommand` action. Add the following code snippet inside `activity.entities`:

```javascript
// Sensitivity label
usageInfo: {
    "@type": "CreativeWork",
    name: "Confidential",
    description: "Sensitive information, do not share outside of your organization.",
}
```

### Step 2: Test the Sensitivity label

Let's test Career Genie with the Sensitivity label. Start debugging your app by selecting **Run and Debug** tab on Visual Studio Code and **Debug in Teams (Edge)** or **Debug in Teams (Chrome)**. Microsoft Teams will pop up on your browser. Once your app details show up on Teams, select **Add** and start chatting with your app.

To test the Sensitivity label, greet Career Genie and then, try to ask one of the questions below, or similar to see the new the sensitivity label:

- *Can you suggest a candidate who is suitable for spanish speaking role that requires at least 2 years of .NET experience?*
- *Who are the other good candidates?*
- *Who would be suitable for a position that requires 5+ python development experience?*
- *Can you suggest any candidates for a senior developer position with 7+ year experience that requires Japanese speaking?*